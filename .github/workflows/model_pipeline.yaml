name: RAG Model Pipeline

on:
  workflow_dispatch:
  push:
    paths:
      - rag_system/config/model_config.yaml

env:
  CI: true
  CI_BASE: rag_system/tests/ci_models
  VECTOR_DB_PATH: rag_system/tests/tmp_vector_db

jobs:

  evaluate_model:
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: rag_system

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install mlflow pyyaml numpy torch transformers safetensors sentence-transformers langchain-chroma langchain langchain-community langchain-huggingface langgraph chromadb

      - name: Ensure CI models exist
        run: |
          mkdir -p ${{ env.CI_BASE }}
          if [ -z "$(ls -A ${{ env.CI_BASE }})" ]; then
            echo "CI models folder empty – downloading all models..."
            python -m rag.models.download_models \
              --config config/model_config.yaml \
              --meta tests/ci_models_meta.json \
              --pvc_base ${{ env.CI_BASE }}
          else
            echo "✅ CI models already exist – skipping download"
          fi

      - name: Ensure CI vector DB
        run: |
          mkdir -p ${{ env.VECTOR_DB_PATH }}
          if ls ${{ env.VECTOR_DB_PATH }}/*.sqlite3 1> /dev/null 2>&1 || ls ${{ env.VECTOR_DB_PATH }}/*.parquet 1> /dev/null 2>&1; then
            echo "✅ CI vector DB already exists – skipping build"
          else
            echo "⚠️ CI vector DB missing – building..."
            # Pass embedding model path to the CI vector DB builder
            EMB_PATH="${{ env.CI_BASE }}/embeddings/all-MiniLM-L6-v2"
            python -m rag.models.build_ci_vector_db

      - name: Prepare CI vector DB
        if: ${{ env.CI == 'true' }}
        run: |
          mkdir -p tests/tmp_vector_db
          cp rag/data/documents/*.txt tests/tmp_vector_db/ || echo "tmp_vector_db already populated"

      - name: Run RAG evaluation
        env:
          MODEL_CONFIG_PATH: config/model_config.yaml
        run: python -m rag.models.build_and_evaluate

  wait_for_approval:
    needs: evaluate_model
    runs-on: ubuntu-latest
    environment:
      name: production  # <-- protected environment requires approval
    steps:
      - name: Manual approval step
        run: echo "Check MLflow metrics, then approve to continue."

  promote_and_deploy:
    needs: wait_for_approval
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: rag_system

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Python SetUp
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install mlflow pyyaml

      - name: Promote model
        env:
          MODEL_CONFIG_PATH: config/model_config.yaml
        run: python -m rag.models.promote_production

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          kubectl config set-cluster rag-cluster \
            --server=${{ secrets.KUBE_API_SERVER }} \
            --insecure-skip-tls-verify=true
          kubectl config set-credentials github-actions \
            --token=${{ secrets.KUBE_TOKEN }}
          kubectl config set-context default \
            --cluster=rag-cluster \
            --user=github-actions
          kubectl config use-context default

      - name: Generate configMap
        run: |
          kubectl create configmap rag-model-config \
            --from-file=model_config.yaml=config/model_config.yaml \
            --dry-run=client -o yaml > configMap.yaml

      - name: Apply ConfigMap
        run: kubectl apply -f configMap.yaml

      - name: Redeploy API
        run: kubectl rollout restart deployment/rag-api

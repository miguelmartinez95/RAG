name: RAG Model Pipeline

on:
  workflow_dispatch:
  push:
    paths:
      - rag_system/config/model_config.yaml

env:
  CI: true
  CI_BASE: rag_system\tests\ci_models
  VECTOR_DB_PATH: rag_system\tests\tmp_vector_db
  PYTHON_DIR: C:\Users\migue\AppData\Local\Programs\Python\Python312

jobs:

  evaluate_model:
    runs-on: [self-hosted, Windows, X64]

    defaults:
      run:
        working-directory: rag_system

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Use installed Python 3.12
        shell: cmd
        run: |
          set PATH=%PYTHON_DIR%;%PATH% && ^
          python --version && ^
          pip --version

      - name: Install Dependencies
        shell: cmd
        run: |
          set PATH=%PYTHON_DIR%;%PATH% && ^
          pip install --upgrade pip && ^
          pip install mlflow pyyaml numpy torch transformers safetensors sentence-transformers langchain-chroma langchain langchain-community langchain-huggingface langgraph chromadb

      - name: Ensure CI models exist
        shell: cmd
        run: |
          if not exist "%CI_BASE%" mkdir "%CI_BASE%" && ^
          cd rag_system && ^
          python -c "import os; print('CI models folder:', os.listdir(r'%CI_BASE%'))" && ^
          python -m rag.models.download_models --config config\model_config.yaml --meta tests\ci_models_meta.json --pvc_base "%CI_BASE%"

      - name: Ensure CI vector DB
        shell: cmd
        run: |
          if not exist "%VECTOR_DB_PATH%" mkdir "%VECTOR_DB_PATH%" && ^
          cd rag_system && ^
          set EMBED_PATH=%CI_BASE%\embeddings\all-MiniLM-L6-v2 && ^
          python -m rag.models.build_ci_vector_db

      - name: Prepare CI vector DB
        shell: cmd
        run: |
          if not exist "tests\tmp_vector_db" mkdir "tests\tmp_vector_db" && ^
          xcopy /E /Y rag\data\documents\* tests\tmp_vector_db\

      - name: Run RAG evaluation
        shell: cmd
        run: |
          cd rag_system && ^
          python -m rag.models.build_and_evaluate --config config\model_config.yaml

  wait_for_approval:
    needs: evaluate_model
    runs-on: [self-hosted, Windows, X64]
    environment:
      name: production
    steps:
      - name: Manual approval step
        shell: cmd
        run: echo Check MLflow metrics, then approve to continue.

  promote_and_deploy:
    needs: wait_for_approval
    runs-on: [self-hosted, Windows, X64]

    defaults:
      run:
        working-directory: rag_system

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Use installed Python 3.12
        shell: cmd
        run: |
          set PATH=%PYTHON_DIR%;%PATH% && ^
          python --version && ^
          pip --version

      - name: Install Dependencies
        shell: cmd
        run: |
          set PATH=%PYTHON_DIR%;%PATH% && ^
          pip install --upgrade pip && ^
          pip install mlflow pyyaml

      - name: Promote model
        shell: cmd
        run: |
          cd rag_system && ^
          python -m rag.models.promote_production --config config\model_config.yaml

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubeconfig
        shell: cmd
        run: |
          kubectl config set-cluster rag-cluster --server=%KUBE_API_SERVER% --insecure-skip-tls-verify=true && ^
          kubectl config set-credentials github-actions --token=%KUBE_TOKEN% && ^
          kubectl config set-context default --cluster=rag-cluster --user=github-actions && ^
          kubectl config use-context default

      - name: Generate configMap
        shell: cmd
        run: |
          kubectl create configmap rag-model-config --from-file=model_config.yaml=config\model_config.yaml --dry-run=client -o yaml > configMap.yaml

      - name: Apply ConfigMap
        shell: cmd
        run: |
          kubectl apply -f configMap.yaml

      - name: Redeploy API
        shell: cmd
        run: |
          kubectl rollout restart deployment/rag-api

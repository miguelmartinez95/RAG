name: RAG Model Pipeline

on:
  workflow_dispatch:
  push:
    paths:
      - k8s/configMap.yaml
      - models/**

jobs:

  evaluate_model:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Python Setup
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install mlflow pyyaml numpy torch transformers safetensors sentence-transformers langchain langchain-community langchain-huggingface langgraph chromadb


      - name: Run MLflow evaluation
        run: python /app/rag/models/build_and_evaluate.py

  wait_for_approval:
    needs: evaluate_model
    runs-on: ubuntu-latest
    environment:
      name: production  # <-- protected environment requires approval
    steps:
      - name: Manual approval step
        run: echo "Check MLflow metrics, then approve to continue."

  promote_and_deploy:
    needs: wait_for_approval
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Python SetUp
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Dependencies
        run: |
          pip install mlflow pyyaml

      - name: Promote model
        run: python /app/rag/models/promote_production.py

      - name: Redeploy API
        run: kubectl rollout restart deployment/rag-api
